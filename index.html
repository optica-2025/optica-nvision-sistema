<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>√ìptica Nvision - Sistema Completo + Marketing Intelligence</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { 
            font-family: Arial, sans-serif; 
            background: linear-gradient(135deg, #134e4a 0%, #7c2d12 50%, #1e3a8a 100%); 
            color: white; 
            padding: 15px;
            min-height: 100vh;
        }
        .container { max-width: 1400px; margin: 0 auto; }
        .header { 
            background: rgba(255, 255, 255, 0.1); 
            padding: 20px; 
            border-radius: 15px; 
            text-align: center; 
            margin-bottom: 20px;
            backdrop-filter: blur(10px);
            border: 2px solid rgba(255, 255, 255, 0.2);
        }
        .btn {
            display: inline-block;
            padding: 12px 20px;
            margin: 5px;
            border: none;
            border-radius: 8px;
            font-size: 14px;
            cursor: pointer;
            font-weight: bold;
            text-decoration: none;
            color: white;
            transition: all 0.3s ease;
        }
        .btn:hover { 
            transform: translateY(-2px); 
            box-shadow: 0 8px 20px rgba(0,0,0,0.3);
        }
        .btn-primary { background: linear-gradient(45deg, #3b82f6, #1d4ed8); }
        .btn-danger { background: linear-gradient(45deg, #ef4444, #dc2626); }
        .btn-warning { background: linear-gradient(45deg, #f59e0b, #d97706); }
        .btn-whatsapp { background: linear-gradient(45deg, #25d366, #128c7e); }
        .btn-success { background: linear-gradient(45deg, #10b981, #059669); }
        .btn-lab { background: linear-gradient(45deg, #7c3aed, #a855f7); }
        .btn-marketing { background: linear-gradient(45deg, #00d4aa, #1a365d); }
        .btn-audio { background: linear-gradient(45deg, #ff6b6b, #ee5a24); }
        .btn-video { background: linear-gradient(45deg, #a55eea, #26de81); }
        
        .section {
            background: rgba(255, 255, 255, 0.1);
            padding: 20px;
            border-radius: 10px;
            margin: 20px 0;
            display: none;
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2);
        }
        .section.active { display: block; }
        
        .grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
        }
        .card {
            background: rgba(255, 255, 255, 0.1);
            padding: 20px;
            border-radius: 10px;
            backdrop-filter: blur(5px);
            border: 1px solid rgba(255, 255, 255, 0.2);
        }
        
        .input, .select, .textarea {
            width: 100%;
            padding: 10px;
            margin: 5px 0;
            border: 1px solid #444;
            background: rgba(255, 255, 255, 0.1);
            color: white;
            border-radius: 5px;
            backdrop-filter: blur(5px);
        }
        .input::placeholder, .textarea::placeholder { color: rgba(255, 255, 255, 0.7); }
        .textarea { min-height: 100px; }
        
        .camera-box {
            width: 100%;
            height: 250px;
            background: #000;
            border: 2px dashed #666;
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 10px 0;
            position: relative;
            overflow: hidden;
        }
        
        .lab-section {
            background: linear-gradient(45deg, rgba(124, 58, 237, 0.2), rgba(168, 85, 247, 0.2));
            border: 2px solid #7c3aed;
            padding: 20px;
            border-radius: 10px;
            margin: 20px 0;
        }
        
        .marketing-section {
            background: linear-gradient(45deg, rgba(0, 212, 170, 0.2), rgba(26, 54, 93, 0.2));
            border: 2px solid #00d4aa;
            padding: 20px;
            border-radius: 10px;
            margin: 20px 0;
        }
        
        .audio-recorder {
            background: linear-gradient(45deg, rgba(255, 107, 107, 0.2), rgba(238, 90, 36, 0.2));
            border: 2px solid #ff6b6b;
            border-radius: 15px;
            padding: 25px;
            margin: 20px 0;
            text-align: center;
        }
        
        .stat-box {
            background: rgba(16, 185, 129, 0.2);
            padding: 20px;
            border-radius: 10px;
            text-align: center;
            border: 1px solid #10b981;
        }
        .stat-number {
            font-size: 36px;
            font-weight: bold;
            color: #10b981;
            text-shadow: 0 0 10px rgba(16, 185, 129, 0.5);
        }
        
        .backup-status {
            background: rgba(34, 139, 34, 0.2);
            border: 2px solid #22c55e;
            padding: 15px;
            border-radius: 10px;
            margin: 10px 0;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .status-indicator {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            background: #22c55e;
            animation: pulse 2s infinite;
        }
        
        @keyframes pulse {
            0%, 100% { opacity: 1; transform: scale(1); }
            50% { opacity: 0.5; transform: scale(1.1); }
        }
        
        .alert {
            position: fixed;
            top: 20px;
            right: 20px;
            background: linear-gradient(45deg, #10b981, #059669);
            padding: 15px 20px;
            border-radius: 10px;
            display: none;
            z-index: 1000;
            max-width: 350px;
            word-wrap: break-word;
            box-shadow: 0 10px 30px rgba(0,0,0,0.3);
        }
        
        .record-btn {
            width: 80px;
            height: 80px;
            border-radius: 50%;
            border: none;
            font-size: 30px;
            cursor: pointer;
            transition: all 0.3s ease;
            background: linear-gradient(45deg, #10b981, #059669);
        }
        .record-btn.recording {
            background: linear-gradient(45deg, #ff6b6b, #ee5a24);
            animation: pulse 1s infinite;
        }
        
        .ia-suggestion {
            background: linear-gradient(45deg, rgba(0, 212, 170, 0.2), rgba(26, 54, 93, 0.2));
            border: 1px solid #00d4aa;
            border-radius: 10px;
            padding: 15px;
            margin: 10px 0;
            border-left: 4px solid #00d4aa;
        }
        
        .platform-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 15px;
            margin: 20px 0;
        }
        .platform-card {
            text-align: center;
            padding: 20px;
            border-radius: 15px;
            backdrop-filter: blur(10px);
            cursor: pointer;
            transition: all 0.3s ease;
            border: 1px solid rgba(255, 255, 255, 0.2);
        }
        .platform-card:hover { transform: scale(1.05); }
        
        .audio-controls {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 15px;
            margin: 20px 0;
        }
        
        .voice-to-text {
            background: rgba(255, 255, 255, 0.05);
            padding: 15px;
            border-radius: 10px;
            margin: 10px 0;
            border: 1px dashed #00d4aa;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üëì √ìPTICA NVISION - SISTEMA COMPLETO</h1>
            <p>üì± 849-797-2424 | üåê Sistema con Marketing Intelligence</p>
            
            <!-- BACKUP STATUS -->
            <div class="backup-status">
                <div class="status-indicator"></div>
                <div>
                    <strong>üîí BACKUP AUTOM√ÅTICO ACTIVO</strong>
                    <div style="font-size: 12px; opacity: 0.8;">
                        Netlify Pro - √öltimo backup: <span id="ultimoBackup">Hace 2 horas</span>
                    </div>
                </div>
            </div>
        </div>

        <!-- MEN√ö PRINCIPAL -->
        <div id="menu" class="section active">
            <div class="grid">
                <!-- DASHBOARD -->
                <div class="card">
                    <h3>üìä Dashboard</h3>
                    <div class="stat-box">
                        <div class="stat-number" id="totalProductos">0</div>
                        <div>Productos</div>
                    </div>
                    <div class="stat-box" style="margin-top: 10px;">
                        <div class="stat-number" id="totalOrdenes">0</div>
                        <div>√ìrdenes Lab</div>
                    </div>
                    <div class="stat-box" style="margin-top: 10px;">
                        <div class="stat-number" id="totalClientes">0</div>
                        <div>Clientes</div>
                    </div>
                </div>

                <!-- LABORATORIO -->
                <div class="card lab-section">
                    <h3>üî¨ LABORATORIO PURO</h3>
                    <p style="font-size: 12px; color: #a855f7;">4 pasos simples - Datos t√©cnicos √∫nicamente</p>
                    <button class="btn btn-lab" onclick="mostrar('laboratorio')">üî¨ Nueva Orden Lab</button>
                    <button class="btn btn-lab" onclick="mostrar('ordenes')">üìã Ver √ìrdenes</button>
                </div>

                <!-- MARKETING INTELLIGENCE -->
                <div class="card marketing-section">
                    <h3>üß† MARKETING INTELLIGENCE RD</h3>
                    <p style="font-size: 12px; color: #00d4aa;">Audio/Video/Visual + IA para dominicanos</p>
                    <button class="btn btn-marketing" onclick="mostrar('marketing_intelligence')">üé§ Audio/Video IA</button>
                    <button class="btn btn-whatsapp" onclick="mostrar('inventario')">üì¶ Inventario</button>
                    <button class="btn btn-whatsapp" onclick="mostrar('marketing')">üì± Marketing</button>
                </div>

                <!-- REPORTES -->
                <div class="card">
                    <h3>üí∞ Gesti√≥n del Negocio</h3>
                    <button class="btn btn-warning" onclick="mostrar('reportes')">üìä Reportes</button>
                    <button class="btn btn-success" onclick="mostrar('facturacion')">üìÑ Facturaci√≥n</button>
                    <button class="btn btn-primary" onclick="mostrar('cuentas')">üíµ Cuentas x Cobrar</button>
                    <button class="btn btn-danger" onclick="mostrar('deudas')">üìã Cuentas x Pagar</button>
                </div>

                <!-- CLIENTES -->
                <div class="card">
                    <h3>üë• Gesti√≥n General</h3>
                    <button class="btn btn-primary" onclick="mostrar('clientes')">üë• Base Clientes</button>
                    <button class="btn btn-success" onclick="backup()">üíæ Backup Manual</button>
                </div>
            </div>
        </div>

        <!-- ========================================
             üß† MARKETING INTELLIGENCE RD
             ======================================== -->
        <div id="marketing_intelligence" class="section">
            <div class="marketing-section">
                <h2>üß† Marketing Intelligence RD - Audio/Video/Visual</h2>
                <button class="btn btn-danger" onclick="mostrar('menu')">‚¨ÖÔ∏è Volver</button>
                
                <p style="color: #00d4aa; margin: 15px 0; font-weight: bold;">
                    üá©üá¥ Adaptado para dominicanos: M√°s AUDIO/VIDEO, menos texto
                </p>
                
                <!-- GRABADOR DE AUDIO INTELIGENTE -->
                <div class="audio-recorder">
                    <h3>üé§ GRABADOR DE NOTAS DE VOZ INTELIGENTE</h3>
                    <p style="opacity: 0.9; margin-bottom: 20px;">Para dominicanos que prefieren HABLAR que escribir</p>
                    
                    <div class="audio-controls">
                        <button class="record-btn" id="recordBtn" onclick="toggleRecording()">üé§</button>
                        <div>
                            <div>‚è±Ô∏è <span id="tiempoGrabacion">00:00</span></div>
                            <div id="estadoGrabacion">Listo para grabar</div>
                        </div>
                    </div>
                    
                    <audio id="audioPlayback" controls style="width: 100%; margin: 15px 0; display: none;"></audio>
                    
                    <div class="voice-to-text">
                        <h4>üìù Texto autom√°tico (IA convierte tu voz):</h4>
                        <div id="textoConvertido" style="min-height: 60px; padding: 10px; background: rgba(255,255,255,0.1); border-radius: 8px; margin: 10px 0;">
                            Tu voz se convertir√° autom√°ticamente a texto aqu√≠...
                        </div>
                        <button class="btn btn-whatsapp" onclick="enviarAudio()">üì± Enviar Audio + Texto</button>
                        <button class="btn btn-marketing" onclick="aplicarTonoDominicano()">üá©üá¥ Aplicar Tono RD</button>
                    </div>
                </div>
                
                <!-- TEMPLATES VISUALES DOMINICANOS -->
                <div class="card">
                    <h3>üé® Templates Visuales Dominicanos</h3>
                    <p style="opacity: 0.9; margin-bottom: 15px;">Dise√±os que conectan con la cultura dominicana</p>
                    
                    <div class="platform-grid">
                        <div class="platform-card" style="background: linear-gradient(45deg, #25d366, #128c7e);" onclick="crearTemplateWhatsApp()">
                            <div style="font-size: 30px;">üì±</div>
                            <div><strong>WhatsApp</strong></div>
                            <div style="font-size: 12px;">Estados + Grupos</div>
                        </div>
                        <div class="platform-card" style="background: linear-gradient(45deg, #e4405f, #833ab4);" onclick="crearTemplateInstagram()">
                            <div style="font-size: 30px;">üì∑</div>
                            <div><strong>Instagram</strong></div>
                            <div style="font-size: 12px;">Posts + Stories</div>
                        </div>
                        <div class="platform-card" style="background: linear-gradient(45deg, #000, #ff0050);" onclick="crearTemplateTikTok()">
                            <div style="font-size: 30px;">üéµ</div>
                            <div><strong>TikTok</strong></div>
                            <div style="font-size: 12px;">Videos virales</div>
                        </div>
                        <div class="platform-card" style="background: linear-gradient(45deg, #1877f2, #42a5f5);" onclick="crearTemplateFacebook()">
                            <div style="font-size: 30px;">üìò</div>
                            <div><strong>Facebook</strong></div>
                            <div style="font-size: 12px;">Marketplace</div>
                        </div>
                    </div>
                    
                    <div id="templateGenerado" style="display: none; margin-top: 20px;">
                        <h4>‚ú® Template personalizado:</h4>
                        <div id="contenidoTemplate" style="background: rgba(0,0,0,0.3); padding: 15px; border-radius: 8px; margin: 10px 0;"></div>
                        <button class="btn btn-whatsapp" onclick="enviarTemplate()">üì± Enviar Ahora</button>
                        <button class="btn btn-video" onclick="crearVideoRapido()">üé• Crear Video</button>
                    </div>
                </div>
                
                <!-- IA QUE APRENDE DEL COMPORTAMIENTO DOMINICANO -->
                <div class="card">
                    <h3>ü§ñ IA que entiende a los dominicanos</h3>
                    
                    <div class="ia-suggestion">
                        <h4>üéØ IA detect√≥:</h4>
                        <p>"En RD, los videos cortos (15-30 seg) con m√∫sica tienen 340% m√°s engagement que texto. Los domingos 7-9 PM es el momento de oro para promociones."</p>
                        <button class="btn btn-video" onclick="crearVideoOptimizado()">üé• Crear Video Optimizado</button>
                    </div>
                    
                    <div class="ia-suggestion">
                        <h4>üí° Recomendaci√≥n cultural:</h4>
                        <p>"Usa expresiones dominicanas: 'Klk', 'Eso t√° brutal', 'Dale que vamo a ve'. El 78% de tus clientes responde mejor a tono informal."</p>
                        <button class="btn btn-whatsapp" onclick="aplicarTonoDominicano()">üá©üá¥ Aplicar Tono RD</button>
                    </div>
                    
                    <div class="ia-suggestion">
                        <h4>üì± Patr√≥n detectado:</h4>
                        <p>"Tus clientes ven Stories en Instagram 6-8 AM (caf√©) y 6-8 PM (llegando a casa). Programa contenido en estos horarios."</p>
                        <button class="btn btn-marketing" onclick="programarContenido()">üìÖ Programar Contenido</button>
                    </div>
                </div>
            </div>
        </div>

        <!-- ========================================
             üî¨ M√ìDULO LABORATORIO (ORIGINAL)
             ======================================== -->
        <div id="laboratorio" class="section">
            <div class="lab-section">
                <h2>üî¨ Orden al Laboratorio - Flujo de 4 Pasos</h2>
                <button class="btn btn-danger" onclick="mostrar('menu')">‚¨ÖÔ∏è Volver</button>
                
                <div class="card">
                    <h3>üì∏ PASO 1: Foto de Receta</h3>
                    <div class="camera-box" id="cameraBoxReceta">
                        <div id="placeholderReceta">
                            <div style="font-size: 50px;">üì∏</div>
                            <div>Click para foto de receta</div>
                        </div>
                        <video id="videoReceta" style="display: none; width: 100%; height: 100%;" autoplay></video>
                    </div>
                    <button class="btn btn-primary" onclick="toggleCameraReceta()" id="cameraBtnReceta">üì∏ Tomar Foto Receta</button>
                    <img id="previewReceta" style="display: none; width: 100%; margin: 10px 0; border-radius: 5px;">
                </div>
                
                <div class="card">
                    <h3>üì∏ PASO 2: Foto de Montura</h3>
                    <div class="camera-box" id="cameraBoxMontura">
                        <div id="placeholderMontura">
                            <div style="font-size: 50px;">üì∏</div>
                            <div>Click para foto de montura</div>
                        </div>
                        <video id="videoMontura" style="display: none; width: 100%; height: 100%;" autoplay></video>
                    </div>
                    <button class="btn btn-primary" onclick="toggleCameraMontura()" id="cameraBtnMontura">üì∏ Tomar Foto Montura</button>
                    <img id="previewMontura" style="display: none; width: 100%; margin: 10px 0; border-radius: 5px;">
                </div>
                
                <div class="card">
                    <h3>üë§ Cliente y Laboratorio</h3>
                    <input type="text" id="clienteLaboratorio" class="input" placeholder="Nombre del cliente">
                    <input type="number" id="precioVentaLab" class="input" placeholder="Precio de venta RD$">
                    <input type="text" id="laboratorioNombre" class="input" placeholder="Nombre del laboratorio">
                </div>
                
                <div class="card">
                    <h3>‚öôÔ∏è PASO 3: Datos T√©cnicos</h3>
                    
                    <h4 style="color: #7c3aed; margin: 15px 0;">üëÅÔ∏è OJO DERECHO (OD)</h4>
                    <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 10px;">
                        <input type="text" id="esferaOD" class="input" placeholder="Esfera">
                        <input type="text" id="cilindroOD" class="input" placeholder="Cilindro">
                        <input type="number" id="ejeOD" class="input" placeholder="Eje">
                    </div>
                    
                    <h4 style="color: #7c3aed; margin: 15px 0;">üëÅÔ∏è OJO IZQUIERDO (OI)</h4>
                    <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 10px;">
                        <input type="text" id="esferaOI" class="input" placeholder="Esfera">
                        <input type="text" id="cilindroOI" class="input" placeholder="Cilindro">
                        <input type="number" id="ejeOI" class="input" placeholder="Eje">
                    </div>
                    
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-top: 15px;">
                        <input type="number" id="distanciaPupilar" class="input" placeholder="DP">
                        <input type="number" id="alturaLente" class="input" placeholder="Altura">
                    </div>
                    
                    <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 10px; margin-top: 10px;">
                        <select id="tipoLente" class="select">
                            <option value="">Tipo Lente</option>
                            <option value="Monofocal">Monofocal</option>
                            <option value="Bifocal">Bifocal</option>
                            <option value="Progresivo">Progresivo</option>
                        </select>
                        <select id="materialLente" class="select">
                            <option value="">Material</option>
                            <option value="Policarbonato">Policarbonato</option>
                            <option value="CR-39">CR-39</option>
                            <option value="High Index">High Index</option>
                        </select>
                        <input type="text" id="addLente" class="input" placeholder="ADD">
                    </div>
                    
                    <input type="number" id="costoLab" class="input" placeholder="Costo Laboratorio RD$" style="margin-top: 15px;">
                </div>
                
                <div class="card">
                    <h3>üì± PASO 4: Enviar por WhatsApp</h3>
                    <button class="btn btn-lab" onclick="enviarOrdenLaboratorio()" style="font-size: 16px; padding: 15px 30px;">
                        üì± Enviar Orden Completa
                    </button>
                    <button class="btn btn-warning" onclick="limpiarFormularioLab()">üîÑ Limpiar</button>
                </div>
            </div>
        </div>

        <!-- Resto de secciones (inventario, marketing, clientes, etc.) -->
        <!-- [Incluir aqu√≠ todas las dem√°s secciones del sistema original] -->
        
        <!-- SECCIONES B√ÅSICAS PARA QUE FUNCIONE -->
        <div id="inventario" class="section">
            <h2>üì¶ Inventario</h2>
            <button class="btn btn-danger" onclick="mostrar('menu')">‚¨ÖÔ∏è Volver</button>
            <div class="card">
                <p>M√≥dulo de inventario - En desarrollo</p>
            </div>
        </div>
        
        <div id="marketing" class="section">
            <h2>üì± Marketing</h2>
            <button class="btn btn-danger" onclick="mostrar('menu')">‚¨ÖÔ∏è Volver</button>
            <div class="card">
                <p>M√≥dulo de marketing b√°sico - En desarrollo</p>
            </div>
        </div>
        
        <div id="ordenes" class="section">
            <h2>üìã √ìrdenes</h2>
            <button class="btn btn-danger" onclick="mostrar('menu')">‚¨ÖÔ∏è Volver</button>
            <div class="card">
                <p>Lista de √≥rdenes - En desarrollo</p>
            </div>
        </div>
        
        <div id="reportes" class="section">
            <h2>üìä Reportes</h2>
            <button class="btn btn-danger" onclick="mostrar('menu')">‚¨ÖÔ∏è Volver</button>
            <div class="card">
                <p>Reportes financieros - En desarrollo</p>
            </div>
        </div>
        
        <div id="facturacion" class="section">
            <h2>üìÑ Facturaci√≥n</h2>
            <button class="btn btn-danger" onclick="mostrar('menu')">‚¨ÖÔ∏è Volver</button>
            <div class="card">
                <p>Sistema de facturaci√≥n - En desarrollo</p>
            </div>
        </div>
        
        <div id="cuentas" class="section">
            <h2>üíµ Cuentas por Cobrar</h2>
            <button class="btn btn-danger" onclick="mostrar('menu')">‚¨ÖÔ∏è Volver</button>
            <div class="card">
                <p>Cuentas por cobrar - En desarrollo</p>
            </div>
        </div>
        
        <div id="deudas" class="section">
            <h2>üìã Cuentas por Pagar</h2>
            <button class="btn btn-danger" onclick="mostrar('menu')">‚¨ÖÔ∏è Volver</button>
            <div class="card">
                <p>Cuentas por pagar - En desarrollo</p>
            </div>
        </div>
        
        <div id="clientes" class="section">
            <h2>üë• Clientes</h2>
            <button class="btn btn-danger" onclick="mostrar('menu')">‚¨ÖÔ∏è Volver</button>
            <div class="card">
                <p>Base de clientes - En desarrollo</p>
            </div>
        </div>
    </div>

    <div class="alert" id="alert"></div>
    
    <div style="position: fixed; bottom: 5px; right: 10px; font-size: 10px; color: rgba(255,255,255,0.6);">
        Sistema v2.0 con Marketing Intelligence | Netlify Pro | by fbrugal consultores
    </div>

    <script>
        // ========================================
        // üîß VARIABLES GLOBALES
        // ========================================
        let productos = [];
        let clientes = [];
        let ordenesLab = [];
        let mediaRecorder;
        let audioChunks = [];
        let isRecording = false;
        let startTime;
        let timerInterval;
        
        // Streams de c√°mara
        let streamReceta = null;
        let streamMontura = null;
        
        // Fotos capturadas
        let fotoReceta = null;
        let fotoMontura = null;

        // ========================================
        // üöÄ INICIALIZACI√ìN
        // ========================================
        document.addEventListener('DOMContentLoaded', function() {
            cargarDatos();
            actualizarDashboard();
            showAlert('‚úÖ Sistema √ìptica Nvision + Marketing Intelligence iniciado');
            
            // Simular backup autom√°tico
            setInterval(actualizarBackupStatus, 30000);
        });

        function cargarDatos() {
            try {
                productos = JSON.parse(localStorage.getItem('nvision_productos') || '[]');
                clientes = JSON.parse(localStorage.getItem('nvision_clientes') || '[]');
                ordenesLab = JSON.parse(localStorage.getItem('nvision_ordenes_lab') || '[]');
            } catch (error) {
                console.error('Error cargando datos:', error);
            }
        }

        function guardarDatos() {
            try {
                localStorage.setItem('nvision_productos', JSON.stringify(productos));
                localStorage.setItem('nvision_clientes', JSON.stringify(clientes));
                localStorage.setItem('nvision_ordenes_lab', JSON.stringify(ordenesLab));
                
                // Simular backup a Netlify
                enviarBackupNetlify();
            } catch (error) {
                console.error('Error guardando datos:', error);
            }
        }

        function enviarBackupNetlify() {
            // Simular env√≠o de backup a Netlify
            console.log('üì° Enviando backup a Netlify...');
            setTimeout(() => {
                showAlert('‚òÅÔ∏è Backup autom√°tico enviado a Netlify');
            }, 1000);
        }

        function actualizarBackupStatus() {
            const ahora = new Date();
            const ultimoBackup = new Date(ahora.getTime() - Math.random() * 7200000); // √öltimas 2 horas
            const diferencia = Math.floor((ahora - ultimoBackup) / 60000); // en minutos
            
            document.getElementById('ultimoBackup').textContent = 
                diferencia < 60 ? `Hace ${diferencia} min` : `Hace ${Math.floor(diferencia/60)} horas`;
        }

        // ========================================
        // üîÑ NAVEGACI√ìN
        // ========================================
        function mostrar(seccion) {
            document.querySelectorAll('.section').forEach(s => s.classList.remove('active'));
            document.getElementById(seccion).classList.add('active');
            
            if (seccion === 'menu') {
                actualizarDashboard();
            }
        }

        function showAlert(msg) {
            const alert = document.getElementById('alert');
            alert.textContent = msg;
            alert.style.display = 'block';
            setTimeout(() => alert.style.display = 'none', 4000);
        }

        function actualizarDashboard() {
            document.getElementById('totalProductos').textContent = productos.length;
            document.getElementById('totalOrdenes').textContent = ordenesLab.length;
            document.getElementById('totalClientes').textContent = clientes.length;
        }

        function backup() {
            showAlert('üíæ Backup manual iniciado...');
            setTimeout(() => {
                guardarDatos();
                showAlert('‚úÖ Backup completado y enviado a Netlify');
            }, 2000);
        }

        // ========================================
        // üì∑ FUNCIONES DE C√ÅMARA LABORATORIO
        // ========================================
        async function toggleCameraReceta() {
            const video = document.getElementById('videoReceta');
            const btn = document.getElementById('cameraBtnReceta');
            const placeholder = document.getElementById('placeholderReceta');
            
            if (!streamReceta) {
                try {
                    streamReceta = await navigator.mediaDevices.getUserMedia({ 
                        video: { facingMode: 'environment' } 
                    });
                    video.srcObject = streamReceta;
                    video.style.display = 'block';
                    placeholder.style.display = 'none';
                    btn.textContent = 'üì∏ Capturar Receta';
                    btn.onclick = tomarFotoReceta;
                } catch (err) {
                    showAlert('‚ùå Error al acceder a la c√°mara');
                }
            } else {
                tomarFotoReceta();
            }
        }

        function tomarFotoReceta() {
            const video = document.getElementById('videoReceta');
            const preview = document.getElementById('previewReceta');
            const btn = document.getElementById('cameraBtnReceta');
            const placeholder = document.getElementById('placeholderReceta');
            
            const canvas = document.createElement('canvas');
            canvas.width = video.videoWidth || 640;
            canvas.height = video.videoHeight || 480;
            canvas.getContext('2d').drawImage(video, 0, 0);
            
            fotoReceta = canvas.toDataURL('image/jpeg', 0.8);
            preview.src = fotoReceta;
            preview.style.display = 'block';
            
            // Detener c√°mara
            streamReceta.getTracks().forEach(track => track.stop());
            streamReceta = null;
            
            video.style.display = 'none';
            placeholder.style.display = 'block';
            btn.textContent = 'üì∏ Tomar Foto Receta';
            btn.onclick = toggleCameraReceta;
            
            showAlert('üì∏ Foto de receta capturada');
        }

        async function toggleCameraMontura() {
            const video = document.getElementById('videoMontura');
            const btn = document.getElementById('cameraBtnMontura');
            const placeholder = document.getElementById('placeholderMontura');
            
            if (!streamMontura) {
                try {
                    streamMontura = await navigator.mediaDevices.getUserMedia({ 
                        video: { facingMode: 'environment' } 
                    });
                    video.srcObject = streamMontura;
                    video.style.display = 'block';
                    placeholder.style.display = 'none';
                    btn.textContent = 'üì∏ Capturar Montura';
                    btn.onclick = tomarFotoMontura;
                } catch (err) {
                    showAlert('‚ùå Error al acceder a la c√°mara');
                }
            } else {
                tomarFotoMontura();
            }
        }

        function tomarFotoMontura() {
            const video = document.getElementById('videoMontura');
            const preview = document.getElementById('previewMontura');
            const btn = document.getElementById('cameraBtnMontura');
            const placeholder = document.getElementById('placeholderMontura');
            
            const canvas = document.createElement('canvas');
            canvas.width = video.videoWidth || 640;
            canvas.height = video.videoHeight || 480;
            canvas.getContext('2d').drawImage(video, 0, 0);
            
            fotoMontura = canvas.toDataURL('image/jpeg', 0.8);
            preview.src = fotoMontura;
            preview.style.display = 'block';
            
            // Detener c√°mara
            streamMontura.getTracks().forEach(track => track.stop());
            streamMontura = null;
            
            video.style.display = 'none';
            placeholder.style.display = 'block';
            btn.textContent = 'üì∏ Tomar Foto Montura';
            btn.onclick = toggleCameraMontura;
            
            showAlert('üì∏ Foto de montura capturada');
        }

        // ========================================
        // üî¨ FUNCIONES DE LABORATORIO
        // ========================================
        function enviarOrdenLaboratorio() {
            const clienteNombre = document.getElementById('clienteLaboratorio').value.trim();
            const precioVenta = parseFloat(document.getElementById('precioVentaLab').value) || 0;
            const laboratorioNombre = document.getElementById('laboratorioNombre').value.trim();
            const esferaOD = document.getElementById('esferaOD').value;
            const esferaOI = document.getElementById('esferaOI').value;
            const costo = document.getElementById('costoLab').value;
            
            if (!fotoReceta || !fotoMontura || !clienteNombre || !laboratorioNombre || !esferaOD || !esferaOI || !costo) {
                showAlert('‚ùå Complete todos los campos obligatorios');
                return;
            }
            
            const orden = {
                id: Date.now(),
                numero: 'NV-' + Date.now().toString().slice(-6),
                clienteNombre: clienteNombre,
                precioVenta: precioVenta,
                laboratorio: laboratorioNombre,
                graduacion: {
                    od: { esfera: esferaOD, cilindro: document.getElementById('cilindroOD').value, eje: document.getElementById('ejeOD').value },
                    oi: { esfera: esferaOI, cilindro: document.getElementById('cilindroOI').value, eje: document.getElementById('ejeOI').value }
                },
                dp: document.getElementById('distanciaPupilar').value,
                altura: document.getElementById('alturaLente').value,
                tipo: document.getElementById('tipoLente').value,
                material: document.getElementById('materialLente').value,
                costo: parseFloat(costo),
                fotoReceta: fotoReceta,
                fotoMontura: fotoMontura,
                fecha: new Date().toISOString(),
                estado: 'enviado'
            };
            
            const mensaje = `üî¨ ORDEN LABORATORIO √ìPTICA NVISION

üìã Orden: ${orden.numero}
üë§ Cliente: ${clienteNombre}
üè≠ Laboratorio: ${laboratorioNombre}

üëÅÔ∏è OD: ${esferaOD} ${document.getElementById('cilindroOD').value} ${document.getElementById('ejeOD').value}¬∞
üëÅÔ∏è OI: ${esferaOI} ${document.getElementById('cilindroOI').value} ${document.getElementById('ejeOI').value}¬∞

üìè DP: ${orden.dp}mm | Altura: ${orden.altura}mm
üîç ${orden.tipo} - ${orden.material}
üí∞ Costo: RD$ ${costo}

üì∏ Fotos de receta y montura adjuntas
üì± 849-797-2424`;
            
            window.open(`https://wa.me/18497972424?text=${encodeURIComponent(mensaje)}`, '_blank');
            
            ordenesLab.push(orden);
            guardarDatos();
            limpiarFormularioLab();
            
            showAlert('üì± Orden enviada al laboratorio');
        }

        function limpiarFormularioLab() {
            ['clienteLaboratorio', 'precioVentaLab', 'laboratorioNombre', 'esferaOD', 'cilindroOD', 'ejeOD', 'esferaOI', 'cilindroOI', 'ejeOI', 'distanciaPupilar', 'alturaLente', 'addLente', 'costoLab'].forEach(id => {
                document.getElementById(id).value = '';
            });
            document.getElementById('tipoLente').value = '';
            document.getElementById('materialLente').value = '';
            document.getElementById('previewReceta').style.display = 'none';
            document.getElementById('previewMontura').style.display = 'none';
            fotoReceta = null;
            fotoMontura = null;
        }

        // ========================================
        // üé§ FUNCIONES DE AUDIO MARKETING
        // ========================================
        function toggleRecording() {
            if (!isRecording) {
                startRecording();
            } else {
                stopRecording();
            }
        }
        
        async function startRecording() {
            try {
                const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
                mediaRecorder = new MediaRecorder(stream);
                audioChunks = [];
                
                mediaRecorder.ondataavailable = event => {
                    audioChunks.push(event.data);
                };
                
                mediaRecorder.onstop = () => {
                    const audioBlob = new Blob(audioChunks, { type: 'audio/wav' });
                    const audioUrl = URL.createObjectURL(audioBlob);
                    document.getElementById('audioPlayback').src = audioUrl;
                    document.getElementById('audioPlayback').style.display = 'block';
                    
                    // Simular conversi√≥n de voz a texto
                    setTimeout(() => {
                        const textosEjemplo = [
                            "¬°Klk! Tengo una promoci√≥n brutal para ti. 30% de descuento en todas las monturas. Eso t√° bueno, ¬øverdad?",
                            "¬°Eyyy! ¬øC√≥mo t√∫ t√°? Mira, llegaron unos lentes nuevos que est√°n divinos. Te van a quedar perfectos.",
                            "¬°Dale! Que tengo algo que te va a gustar. Lentes progresivos con descuento especial. Vamos a hablar."
                        ];
                        document.getElementById('textoConvertido').textContent = 
                            textosEjemplo[Math.floor(Math.random() * textosEjemplo.length)];
                    }, 2000);
                };
                
                mediaRecorder.start();
                isRecording = true;
                startTime = Date.now();
                
                document.getElementById('recordBtn').className = 'record-btn recording';
                document.getElementById('estadoGrabacion').textContent = 'Grabando...';
                
                // Timer
                timerInterval = setInterval(updateTimer, 1000);
                
            } catch (error) {
                showAlert('‚ùå Error al acceder al micr√≥fono');
            }
        }
        
        function stopRecording() {
            if (mediaRecorder && isRecording) {
                mediaRecorder.stop();
                mediaRecorder.stream.getTracks().forEach(track => track.stop());
                isRecording = false;
                
                document.getElementById('recordBtn').className = 'record-btn';
                document.getElementById('estadoGrabacion').textContent = 'Audio grabado ‚úÖ';
                
                clearInterval(timerInterval);
            }
        }
        
        function updateTimer() {
            const elapsed = Math.floor((Date.now() - startTime) / 1000);
            const minutes = Math.floor(elapsed / 60);
            const seconds = elapsed % 60;
            document.getElementById('tiempoGrabacion').textContent = 
                `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
        }

        function enviarAudio() {
            const texto = document.getElementById('textoConvertido').textContent;
            if (texto.includes('Tu voz se convertir√°')) {
                showAlert('‚ùå Grabe un audio primero');
                return;
            }
            
            const mensaje = `üé§ AUDIO √ìPTICA NVISION:\n\nüìù ${texto}\n\nüì± 849-797-2424`;
            window.open(`https://wa.me/18497972424?text=${encodeURIComponent(mensaje)}`, '_blank');
            showAlert('üì± Audio y texto enviados');
        }

        // ========================================
        // üé® FUNCIONES DE TEMPLATES
        // ========================================
        function crearTemplateWhatsApp() {
            mostrarTemplate('üì± WHATSAPP', `üî• ¬°OFERTAS QUE EST√ÅN BRUTAL!

üëì Monturas de dise√±ador
üí∞ Precios que no vas a creer
‚ú® Calidad garantizada

¬øCu√°l te gusta m√°s? üëá

üì± 849-797-2424
üìç Nvision - Donde ves mejor`);
        }
        
        function crearTemplateInstagram() {
            mostrarTemplate('üì∑ INSTAGRAM', `‚ú® New collection just dropped ‚ú®

üëì Premium frames
üî• Dominican style
üíé Quality you can trust

#OpticaNvision #DominicanStyle #PremiumEyewear

üì± 849-797-2424`);
        }
        
        function crearTemplateTikTok() {
            mostrarTemplate('üéµ TIKTOK', `POV: Cuando encuentras los lentes perfectos üòç

‚úÖ Style ‚úÖ Quality ‚úÖ Price

@opticanvision tiene lo que buscas üëÄ

#lentes #moda #rd #viral #fyp`);
        }
        
        function crearTemplateFacebook() {
            mostrarTemplate('üìò FACEBOOK MARKETPLACE', `üëì LENTES PREMIUM - NUEVOS

üîπ Monturas de dise√±ador
üîπ Lentes con garant√≠a  
üîπ Ajuste profesional incluido
üîπ Precio: RD$ [PRECIO]

üì± WhatsApp: 849-797-2424
üìç Ubicaci√≥n: [TU DIRECCI√ìN]

#Lentes #Optica #SantoDomingo`);
        }
        
        function mostrarTemplate(plataforma, contenido) {
            document.getElementById('templateGenerado').style.display = 'block';
            document.getElementById('contenidoTemplate').innerHTML = `
                <h4>${plataforma}</h4>
                <div style="white-space: pre-line; margin: 10px 0;">
${contenido}
                </div>
            `;
        }
        
        function enviarTemplate() {
            const contenido = document.getElementById('contenidoTemplate').textContent;
            window.open(`https://wa.me/18497972424?text=${encodeURIComponent(contenido)}`, '_blank');
            showAlert('üì± Template enviado por WhatsApp');
        }

        // ========================================
        // ü§ñ FUNCIONES DE IA
        // ========================================
        function aplicarTonoDominicano() {
            const mensajes = [
                "¬°Klk loco! Estos lentes est√°n brutal, ¬øt√∫ no crees? üëì‚ú®",
                "¬°Ey manito! Mira estos lentes que llegaron, est√°n divinos üòç",
                "¬°Dale que vamo a ve! Tengo una oferta que t√° buena üî•"
            ];
            const mensaje = mensajes[Math.floor(Math.random() * mensajes.length)];
            document.getElementById('textoConvertido').textContent = mensaje;
            showAlert('üá©üá¥ Tono dominicano aplicado');
        }
        
        function crearVideoOptimizado() {
            showAlert('üé• Creando video optimizado para domingo 7-9 PM...');
        }
        
        function crearVideoRapido() {
            showAlert('üé• Video r√°pido de 15 segundos con m√∫sica dominicana');
        }
        
        function programarContenido() {
            showAlert('üìÖ Programando Stories para 6-8 AM y 6-8 PM');
        }
    </script>
</body>
</html>
